master_dns = 'dns-name-of-master'

passwords = data_bag_item('mysql', 'passwords')

execute 'set server id' do
  command `sed -i 's/server-id.*/server-id = 2/' /etc/mysql-default/my.cnf`
end

execute 'set relay log' do
  command `sed -i '/server-id/a \
relay-log = /var/log/mysql-default/mysql-relay-bin.log\
' /etc/mysql-default/my.cnf`
end

include_recipe '::mysql_flush'

master_nodes = search(:node, 'hostname:db-master')
master_nodes.each do |master|
  master_file = "#{master_node.master_file}"
  master_pos = "#{master_node.master_pos}"
end

# ruby_block "start_replication" do
#   block do
#     master_node = search(:node, 'hostname:db-master').first
#     master_file = "#{master_node.master_file}"
#     master_pos = "#{master_node.master_pos}"
#   end
# end

# master_node = search(:node, 'hostname:db-master')
# master_file = "#{master_node[0][:master_file]}"
# master_pos = "#{master_node[0][:master_pos]}"

execute 'setup slave' do
  command `mysql -S /var/run/mysql-default/mysqld.sock -u root -p#{passwords['root']} -e "CHANGE MASTER TO MASTER_HOST='#{master_dns}', MASTER_USER='repl', MASTER_PASSWORD='#{passwords['repl']}', MASTER_LOG_FILE = '#{master_file}', MASTER_LOG_POS = #{master_pos};"`
end

execute 'start slave' do
  command `mysql -S /var/run/mysql-default/mysqld.sock -u root -p#{passwords['root']} -e "START SLAVE;"`
  notifies :restart, 'mysql_service[default]'
end
